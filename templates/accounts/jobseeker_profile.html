{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="card shadow profile-card p-4">

        <!-- ================= VIEW MODE ================= -->
        <div id="view-mode" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>My Profile</h3>
                <button class="btn btn-outline-primary" onclick="enableEdit()">Edit Profile</button>
            </div>
            <hr>

            <p><strong>Full Name:</strong> <span id="v-name"></span></p>
            <p><strong>Email:</strong> {{ request.user.email }}</p>
            <p><strong>Phone:</strong> <span id="v-phone"></span></p>
            <p><strong>Location:</strong> <span id="v-location"></span></p>

            <p class="mt-3"><strong>Bio</strong></p>
            <p id="v-bio"></p>

            <p class="mt-3"><strong>Skills</strong></p>
            <div id="v-skills"></div>

            <p class="mt-3"><strong>Education</strong></p>
            <p id="v-education"></p>

            <p class="mt-3"><strong>Experience</strong></p>
            <p><span id="v-exp-level"></span> | <span id="v-exp-years"></span> years</p>

            <p class="mt-3"><strong>Links</strong></p>
            <p>
                <a id="v-linkedin" target="_blank">LinkedIn</a> |
                <a id="v-github" target="_blank">GitHub</a>
            </p>

            <p class="mt-3"><strong>CV</strong></p>
            <a id="v-cv" class="btn btn-sm btn-success" target="_blank" style="display:none;">
                Download CV
            </a>
        </div>

        <!-- ================= EDIT MODE ================= -->
        <div id="edit-mode" style="display:none;">
            <h3 id="form-title">Complete Your Profile</h3>
            <hr>

            <form id="profile-form" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Full Name</label>
                        <input type="text" class="form-control" id="full_name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Email</label>
                        <input type="email" class="form-control" value="{{ request.user.email }}" readonly>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Phone</label>
                        <input type="text" class="form-control" id="phone">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Location</label>
                        <input type="text" class="form-control" id="location">
                    </div>
                </div>

                <div class="mb-3">
                    <label>Bio</label>
                    <textarea class="form-control" id="bio" rows="3"></textarea>
                </div>

                <div class="mb-3">
                    <label>Skills (comma separated)</label>
                    <input type="text" class="form-control" id="skills">
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Education</label>
                        <input type="text" class="form-control" id="education">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Experience Level</label>
                        <select class="form-select" id="experience_level">
                            <option value="fresher">Fresher</option>
                            <option value="junior">Junior</option>
                            <option value="mid">Mid</option>
                            <option value="senior">Senior</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label>Years of Experience</label>
                    <input type="number" class="form-control" id="years_of_experience" min="0">
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>LinkedIn</label>
                        <input type="url" class="form-control" id="linkedin">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>GitHub</label>
                        <input type="url" class="form-control" id="github">
                    </div>
                </div>

                <div class="mb-3">
                    <label>Upload CV (PDF/DOCX)</label>
                    <input type="file" class="form-control" id="cv" accept=".pdf,.doc,.docx">
                </div>

                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary px-4" onclick="saveProfile()">Save</button>
                    <button type="button" class="btn btn-secondary px-4" onclick="cancelEdit()">Cancel</button>
                </div>
            </form>
        </div>

    </div>
</div>

<script>
let profileExists = false;

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function enableEdit() {
    document.getElementById('view-mode').style.display = 'none';
    document.getElementById('edit-mode').style.display = 'block';
}

function cancelEdit() {
    document.getElementById('edit-mode').style.display = profileExists ? 'none' : 'block';
    document.getElementById('view-mode').style.display = profileExists ? 'block' : 'none';
}

async function loadProfile() {
    const res = await fetch('/api/jobseeker/profile/', { credentials: 'same-origin' });
    const data = await res.json();

    if (!data.exists) {
        document.getElementById('edit-mode').style.display = 'block';
        return;
    }

    profileExists = true;
    const p = data.profile;

    document.getElementById('view-mode').style.display = 'block';
    document.getElementById('edit-mode').style.display = 'none';

    document.getElementById('v-name').innerText = p.full_name || '';
    document.getElementById('v-phone').innerText = p.phone || '';
    document.getElementById('v-location').innerText = p.location || '';
    document.getElementById('v-bio').innerText = p.bio || '';
    document.getElementById('v-education').innerText = p.education || '';
    document.getElementById('v-exp-level').innerText = p.experience_level || '';
    document.getElementById('v-exp-years').innerText = p.years_of_experience || '';

    document.getElementById('v-linkedin').href = p.linkedin || '#';
    document.getElementById('v-github').href = p.github || '#';

    const skillsDiv = document.getElementById('v-skills');
    skillsDiv.innerHTML = '';
    (p.skills || '').split(',').forEach(s => {
        if (s.trim()) {
            skillsDiv.innerHTML += `<span class="badge bg-primary me-1">${s.trim()}</span>`;
        }
    });

    if (p.cv) {
        document.getElementById('v-cv').href = p.cv;
        document.getElementById('v-cv').style.display = 'inline-block';
    }
}

async function saveProfile() {
    const formData = new FormData();

    ['full_name','phone','location','bio','skills','education','experience_level','years_of_experience','linkedin','github']
    .forEach(id => formData.append(id, document.getElementById(id).value));

    const cv = document.getElementById('cv').files[0];
    if (cv) formData.append('cv', cv);

    const res = await fetch('/api/jobseeker/profile/save/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        body: formData,
        credentials: 'same-origin'
    });

    const data = await res.json();
    if (data.success) {
        alert("Profile saved successfully");
        loadProfile();
    } else {
        console.error(data);
        alert("Error saving profile");
    }
}

document.addEventListener('DOMContentLoaded', loadProfile);
</script>

<style>
.profile-card {
    max-width: 900px;
    margin: auto;
    border-radius: 12px;
}
</style>
{% endblock %}
