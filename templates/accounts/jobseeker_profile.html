{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 mb-5">

    <div class="card shadow profile-card p-4">
        <!-- ================= VIEW MODE ================= -->
        <div id="view-mode" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>My Profile</h3>
                <button class="btn btn-outline-primary" onclick="enableEdit()">Edit Profile</button>
            </div>
            <hr>

            <p><span class="profile-label">Full Name:</span> <span id="v-name"></span></p>
            <p><span class="profile-label">Email:</span> <span id="v-email"></span></p>
            <p><span class="profile-label">Phone:</span> <span id="v-phone"></span></p>
            <p><span class="profile-label">Location:</span> <span id="v-location"></span></p>

            <p class="profile-label mt-2">Bio</p>
            <p id="v-bio"></p>

            <p class="profile-label mt-2">Skills</p>
            <div id="v-skills"></div>

            <p class="profile-label mt-2">Education</p>
            <p id="v-education"></p>

            <p class="profile-label mt-2">Experience</p>
            <p>
                <span id="v-exp-level"></span> |
                <span id="v-exp-years"></span> years
            </p>

            <p class="profile-label mt-2">Links</p>
            <p>
                <a id="v-linkedin" target="_blank">LinkedIn</a> |
                <a id="v-github" target="_blank">GitHub</a>
            </p>
        </div>

        <!-- ================= EDIT MODE ================= -->
        <div id="edit-mode" style="display:none;">
            <h3 id="form-title">Complete Your Profile</h3>
            <hr>
            <form id="profile-form">
                {% csrf_token %}

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="full_name">Full Name</label>
                        <input type="text" class="form-control" id="full_name" name="full_name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required readonly>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="phone">Phone</label>
                        <input type="text" class="form-control" id="phone" name="phone" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="location">Location</label>
                        <input type="text" class="form-control" id="location" name="location" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="bio">Bio</label>
                    <textarea class="form-control" rows="3" id="bio" name="bio" required></textarea>
                </div>

                <div class="mb-3">
                    <label for="skills">Skills (comma separated)</label>
                    <input type="text" class="form-control" id="skills" name="skills" required>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="education">Education</label>
                        <input type="text" class="form-control" id="education" name="education" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="experience_level">Experience Level</label>
                        <select class="form-select" id="experience_level" name="experience_level">
                            <option value="fresher">Fresher</option>
                            <option value="junior">Junior</option>
                            <option value="mid">Mid</option>
                            <option value="senior">Senior</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="years_of_experience">Years of Experience</label>
                    <input type="number" class="form-control" id="years_of_experience" name="years_of_experience" min="0" required>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="linkedin">LinkedIn</label>
                        <input type="url" class="form-control" id="linkedin" name="linkedin">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="github">GitHub</label>
                        <input type="url" class="form-control" id="github" name="github">
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary px-4" onclick="saveProfile()">Save</button>
                    <button type="button" class="btn btn-secondary px-4" onclick="cancelEdit()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================= JS LOGIC ================= -->
<script>
let profileExists = false;

// CSRF helper
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Enable Edit Mode
function enableEdit() {
    document.getElementById('view-mode').style.display = 'none';
    document.getElementById('edit-mode').style.display = 'block';
    document.getElementById('form-title').innerText = profileExists ? "Edit Profile" : "Complete Your Profile";
}

// Cancel Edit
function cancelEdit() {
    if(profileExists){
        document.getElementById('edit-mode').style.display = 'none';
        document.getElementById('view-mode').style.display = 'block';
    } else {
        document.getElementById('profile-form').reset();
    }
}

// Load profile
async function loadProfile() {
    try {
        const res = await fetch('/api/jobseeker/profile/', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
        });
        const data = await res.json();

        if(data.exists){
            profileExists = true;
            const profile = data.profile;

            document.getElementById('view-mode').style.display = 'block';
            document.getElementById('edit-mode').style.display = 'none';

            // View mode
            document.getElementById('v-name').innerText = profile.full_name;
            document.getElementById('v-email').innerText = "{{ request.user.email }}";
            document.getElementById('v-phone').innerText = profile.phone || '';
            document.getElementById('v-location').innerText = profile.location || '';
            document.getElementById('v-bio').innerText = profile.bio || '';
            document.getElementById('v-education').innerText = profile.education || '';
            document.getElementById('v-exp-level').innerText = profile.experience_level || '';
            document.getElementById('v-exp-years').innerText = profile.years_of_experience || 0;
            document.getElementById('v-linkedin').href = profile.linkedin || '#';
            document.getElementById('v-github').href = profile.github || '#';

            // Skills badges
            const skillsDiv = document.getElementById('v-skills');
            skillsDiv.innerHTML = '';
            profile.skills?.split(',').forEach(skill => {
                const span = document.createElement('span');
                span.className = 'badge bg-primary me-1';
                span.innerText = skill.trim();
                skillsDiv.appendChild(span);
            });

            // Pre-fill edit form
            document.getElementById('full_name').value = profile.full_name;
            document.getElementById('email').value = "{{ request.user.email }}";
            document.getElementById('phone').value = profile.phone || '';
            document.getElementById('location').value = profile.location || '';
            document.getElementById('bio').value = profile.bio || '';
            document.getElementById('skills').value = profile.skills || '';
            document.getElementById('education').value = profile.education || '';
            document.getElementById('experience_level').value = profile.experience_level || 'fresher';
            document.getElementById('years_of_experience').value = profile.years_of_experience || 0;
            document.getElementById('linkedin').value = profile.linkedin || '';
            document.getElementById('github').value = profile.github || '';
        } else {
            profileExists = false;
            document.getElementById('edit-mode').style.display = 'block';
            document.getElementById('view-mode').style.display = 'none';
            document.getElementById('form-title').innerText = "Complete Your Profile";
            document.getElementById('email').value = "{{ request.user.email }}";
        }
    } catch(err){
        console.error("Error loading profile:", err);
    }
}

// Save profile
async function saveProfile() {
    const payload = {
        full_name: document.getElementById('full_name').value,
        phone: document.getElementById('phone').value,
        location: document.getElementById('location').value,
        bio: document.getElementById('bio').value,
        skills: document.getElementById('skills').value,
        education: document.getElementById('education').value,
        experience_level: document.getElementById('experience_level').value,
        years_of_experience: parseInt(document.getElementById('years_of_experience').value) || 0,
        linkedin: document.getElementById('linkedin').value.startsWith('http') ? document.getElementById('linkedin').value : 'https://' + document.getElementById('linkedin').value,
        github: document.getElementById('github').value
    };

    try {
        const res = await fetch('/api/jobseeker/profile/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(payload),
            credentials: 'same-origin'
        });

        const data = await res.json();

        if(data.success){
            profileExists = true;

            // Update view-mode dynamically
            document.getElementById('view-mode').style.display = 'block';
            document.getElementById('edit-mode').style.display = 'none';
            document.getElementById('v-name').innerText = payload.full_name;
            document.getElementById('v-phone').innerText = payload.phone;
            document.getElementById('v-location').innerText = payload.location;
            document.getElementById('v-bio').innerText = payload.bio;
            document.getElementById('v-education').innerText = payload.education;
            document.getElementById('v-exp-level').innerText = payload.experience_level;
            document.getElementById('v-exp-years').innerText = payload.years_of_experience;
            document.getElementById('v-linkedin').href = payload.linkedin || '#';
            document.getElementById('v-github').href = payload.github || '#';

            // Update skills badges
            const skillsDiv = document.getElementById('v-skills');
            skillsDiv.innerHTML = '';
            payload.skills.split(',').forEach(skill => {
                const span = document.createElement('span');
                span.className = 'badge bg-primary me-1';
                span.innerText = skill.trim();
                skillsDiv.appendChild(span);
            });

            alert("Profile saved successfully!");
        } else {
            console.error("Backend error:", data);
            alert("Error saving profile. Check console for details.");
        }
    } catch(err){
        console.error("Network error:", err);
        alert("Network/server error while saving profile.");
    }
}

// Initialize
document.addEventListener("DOMContentLoaded", loadProfile);
</script>

<style>
.profile-card {
    max-width: 900px;
    margin: auto;
    border-radius: 12px;
}
.profile-label {
    font-weight: 600;
    color: #6c757d;
}
</style>
{% endblock %}
