{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container py-5">

  <!-- ================= PAGE TITLE ================= -->
  <div class="text-center mb-4">
    <h2 class="fw-bold">All Job Openings</h2>
    <p class="text-muted">Search, filter and apply to jobs that match your skills</p>
  </div>

  <!-- ================= SEARCH & FILTER ================= -->
  <form method="GET" class="card shadow-sm border-0 p-3 mb-5">
    <div class="row g-3 align-items-end">

      <div class="col-md-4">
        <label class="form-label">Search Jobs</label>
        <input type="text" name="q" class="form-control"
               placeholder="Job title, company or skills"
               value="{{ request.GET.q }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Location</label>
        <input type="text" name="location" class="form-control"
               placeholder="e.g. Kathmandu"
               value="{{ request.GET.location }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Posted</label>
        <select name="date" class="form-select">
          <option value="">Any time</option>
          <option value="1">Last 24 hrs</option>
          <option value="7">Last 7 days</option>
          <option value="30">Last 30 days</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Min Match %</label>
        <select name="match" class="form-select">
          <option value="">Any</option>
          <option value="70">70+</option>
          <option value="80">80+</option>
          <option value="90">90+</option>
        </select>
      </div>

      <div class="col-md-1 d-grid">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search"></i>
        </button>
      </div>

    </div>
  </form>

  <!-- ================= JOB LIST ================= -->
  <div class="row g-4">

    {% for job in jobs %}
    <div class="col-lg-4 col-md-6">
      <div class="card h-100 shadow-sm border-0 job-card position-relative">

        <!-- Match Badge -->
        {% if job.match_score != None %}
        <span class="badge position-absolute top-0 end-0 m-2
          {% if job.match_score >= 90 %} bg-success
          {% elif job.match_score >= 70 %} bg-warning
          {% else %} bg-danger {% endif %}">
          {{ job.match_score }}% Match
        </span>
        {% endif %}

        <div class="card-body d-flex flex-column">

          <h5 class="fw-bold text-primary">{{ job.job_title }}</h5>

          <p class="text-muted mb-1">
            <i class="bi bi-building"></i>
            {{ job.company.company_name }}
          </p>

          <p class="text-muted mb-2">
            <i class="bi bi-geo-alt"></i>
            {{ job.location }}
          </p>

          {% if job.skills_list %}
          <div class="mb-3">
            {% for skill in job.skills_list %}
              <span class="badge bg-light text-dark border me-1 mb-1">
                {{ skill }}
              </span>
            {% endfor %}
          </div>
          {% endif %}

          <div class="mt-auto">

            <!-- VIEW BUTTON -->
            <button type="button"
                    class="btn btn-outline-primary btn-sm w-100 mb-2"
                    data-bs-toggle="modal"
                    data-bs-target="#viewJobModal{{ job.id }}">
              View Details
            </button>

            <!-- APPLY BUTTON -->
            {% if user.is_authenticated and user.is_job_seeker %}
              {% if job.match_score >= 70 %}
              <button type="button"
                      class="btn btn-success btn-sm w-100"
                      data-bs-toggle="modal"
                      data-bs-target="#applyModal{{ job.id }}">
                Apply Now
              </button>
              {% else %}
              <button class="btn btn-secondary btn-sm w-100" disabled>
                Apply Disabled
              </button>
              <small class="text-danger d-block text-center mt-1">
                Match score below 70, canâ€™t apply
              </small>
              {% endif %}
            {% endif %}

          </div>
        </div>
      </div>
    </div>

    <!-- ================= VIEW JOB MODAL ================= -->
    <div class="modal fade" id="viewJobModal{{ job.id }}" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title fw-bold">{{ job.job_title }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <p><strong>Company:</strong> {{ job.company.company_name }}</p>
            <p><strong>Location:</strong> {{ job.location }}</p>

            {% if job.salary %}
            <p><strong>Salary:</strong> {{ job.salary }}</p>
            {% endif %}

            <hr>

            <h6 class="fw-bold">Job Description</h6>
            <p>{{ job.job_description }}</p>

            {% if job.skills_required %}
            <h6 class="fw-bold mt-3">Skills Required</h6>
            <p>{{ job.skills_required }}</p>
            {% endif %}
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

            {% if user.is_authenticated and user.is_job_seeker and job.match_score >= 70 %}
            <button type="button"
                    class="btn btn-success"
                    data-bs-toggle="modal"
                    data-bs-target="#applyModal{{ job.id }}"
                    data-bs-dismiss="modal">
              Apply Now
            </button>
            {% endif %}
          </div>

        </div>
      </div>
    </div>

    <!-- ================= APPLY JOB MODAL ================= -->
    <div class="modal fade" id="applyModal{{ job.id }}" tabindex="-1">
      <div class="modal-dialog">
        <form method="POST"
              action="{% url 'jobs:apply-job' job.id %}"
              enctype="multipart/form-data"
              class="modal-content">

          {% csrf_token %}

          <div class="modal-header">
            <h5 class="modal-title">Apply for {{ job.job_title }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label>Name</label>
              <input type="text" class="form-control" value="{{ user.full_name }}" readonly>
            </div>

            <div class="mb-3">
              <label>Email</label>
              <input type="email" class="form-control" value="{{ user.email }}" readonly>
            </div>

            <div class="mb-3">
              <label>Phone Number</label>
              <input type="text" name="phone" class="form-control" required>
            </div>

            <div class="mb-3">
              <label>Upload CV</label>
              <input type="file" name="cv" class="form-control"
                     accept=".pdf,.doc,.docx" required>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Submit Application</button>
          </div>

        </form>
      </div>
    </div>

    {% empty %}
    <div class="text-center">
      <p class="text-muted">No jobs found.</p>
    </div>
    {% endfor %}

  </div>
</div>

<!-- ================= STYLES ================= -->
<style>
.job-card {
  border-radius: 14px;
  transition: all 0.3s ease;
}
.job-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

{% endblock %}
