{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container py-5">

  <!-- ================= PAGE TITLE ================= -->
  <div class="text-center mb-4">
    <h2 class="fw-bold">All Job Openings</h2>
    <p class="text-muted">Search, filter and apply to jobs that match your skills</p>
  </div>

  <!-- ================= SEARCH & FILTER ================= -->
  <form method="GET" class="card shadow-sm border-0 p-3 mb-5">
    <div class="row g-3 align-items-end">

      <div class="col-md-4">
        <label class="form-label">Search Jobs</label>
        <input type="text" name="q" class="form-control"
               placeholder="Job title, company or skills"
               value="{{ request.GET.q }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Location</label>
        <input type="text" name="location" class="form-control"
               placeholder="e.g. Kathmandu"
               value="{{ request.GET.location }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Posted</label>
        <select name="date" class="form-select">
          <option value="">Any time</option>
          <option value="1">Last 24 hrs</option>
          <option value="7">Last 7 days</option>
          <option value="30">Last 30 days</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Min Match %</label>
        <select name="match" class="form-select">
          <option value="">Any</option>
          <option value="70">70+</option>
          <option value="80">80+</option>
          <option value="90">90+</option>
        </select>
      </div>

      <div class="col-md-1 d-grid">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search"></i>
        </button>
      </div>

    </div>
  </form>

  <!-- ================= JOB LIST ================= -->
  <div class="row g-4">

    {% for job in jobs %}
    <div class="col-lg-4 col-md-6">
      <div class="card h-100 shadow-sm border-0 job-card position-relative">

        {% if job.match_score != None %}
        <span class="badge position-absolute top-0 end-0 m-2
          {% if job.match_score >= 90 %} bg-success
          {% elif job.match_score >= 70 %} bg-warning
          {% else %} bg-danger {% endif %}">
          {{ job.match_score }}% Match
        </span>
        {% endif %}

        <div class="card-body d-flex flex-column">

          <h5 class="fw-bold text-primary">{{ job.job_title }}</h5>

          <p class="text-muted mb-1">
            <i class="bi bi-building"></i>
            {{ job.company.company_name }}
          </p>

          <p class="text-muted mb-2">
            <i class="bi bi-geo-alt"></i>
            {{ job.location }}
          </p>

          {% if job.skills_list %}
          <div class="mb-3">
            {% for skill in job.skills_list %}
              <span class="badge bg-light text-dark border me-1 mb-1">
                {{ skill }}
              </span>
            {% endfor %}
          </div>
          {% endif %}

          <div class="mt-auto d-grid gap-2">

            <a href="{% url 'jobs:job_detail' job.id %}"
               class="btn btn-outline-primary btn-sm">
              View Details
            </a>

            {% if user.is_authenticated and user.is_job_seeker %}
              <button type="button"
                      class="btn btn-success btn-sm apply-btn"
                      data-bs-toggle="modal"
                      data-bs-target="#applyModal"
                      data-job-id="{{ job.id }}">
                Apply Now
              </button>
            {% endif %}

          </div>

        </div>
      </div>
    </div>
    {% empty %}
    <div class="text-center">
      <p class="text-muted">No jobs found.</p>
    </div>
    {% endfor %}

  </div>
</div>

<!-- ================= SINGLE APPLY MODAL ================= -->
{% if user.is_authenticated and user.is_job_seeker %}
  {% include "jobs/_apply_modal.html" %}
{% endif %}

<!-- ================= SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("applyModal");
  const form = document.getElementById("applyForm");

  modal.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const jobId = button.getAttribute("data-job-id");

    form.action = form.action.replace(/0\/$/, jobId + "/");
    form.querySelector('input[name="job_id"]').value = jobId;
  });
});
</script>


<!-- ================= STYLES ================= -->
<style>
.job-card {
  border-radius: 14px;
  transition: all 0.3s ease;
}
.job-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}
